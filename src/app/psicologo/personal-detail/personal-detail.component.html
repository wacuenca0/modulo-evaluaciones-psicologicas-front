<div class="personal-detail-wrapper">
  <div class="personal-detail-main">
    <section class="space-y-8">
      <header class="flex flex-wrap items-start justify-between gap-4">
        <div class="space-y-2">
          <p class="text-xs font-semibold uppercase tracking-widest text-slate-500">Gestion clinica</p>
          <h1 class="text-3xl font-semibold text-slate-900">{{ titulo() }}</h1>
          <p class="text-sm text-slate-500 max-w-2xl">Completa la informacion por secciones para registrar o actualizar al personal militar.</p>
        </div>
        <button type="button" (click)="cerrar()"
          class="rounded-md border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100"
          [disabled]="cargando()">
          Cerrar
        </button>
      </header>
      <nav class="grid gap-3 sm:grid-cols-2 xl:grid-cols-4">
        <div *ngFor="let paso of pasos; let index = index" [ngClass]="pasoCardClass(index)" class="transition-all duration-300">
          <div class="flex items-center justify-between">
            <p class="text-[11px] font-bold uppercase tracking-widest">Paso {{ index + 1 }}</p>
            <span [ngClass]="pasoIndicatorClass(index)" aria-hidden="true"></span>
          </div>
          <p class="mt-1 text-sm font-semibold">{{ paso.titulo }}</p>
          <p class="text-xs" [ngClass]="pasoActual() === index ? 'text-white/80' : 'text-slate-600'">{{ paso.descripcion }}</p>
        </div>
      </nav>

      <div *ngIf="mensajeError()" class="flex items-start gap-3 rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
        <span aria-hidden="true" class="mt-0.5 text-base font-semibold">!</span>
        <p class="flex-1">{{ mensajeError() }}</p>
      </div>

      <div *ngIf="mensajeExito()" class="flex items-center justify-between gap-3 rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700">
        <span>{{ mensajeExito() }}</span>
        <span aria-hidden="true" class="inline-flex h-2 w-2 animate-ping rounded-full bg-emerald-500"></span>
      </div>

      <article *ngIf="persona()" class="relative overflow-hidden rounded-3xl border-2 border-slate-200 bg-gradient-to-r from-slate-50 to-white p-6 shadow-sm">
        <header class="flex flex-wrap items-center justify-between gap-6">
          <div class="flex items-start gap-4">
            <!-- Avatar -->
            <div class="relative grid h-14 w-14 place-items-center rounded-2xl bg-gradient-to-br from-slate-800 to-slate-600 text-white shadow-lg ring-2 ring-white/60">
              <span class="text-lg font-bold">{{ personaIniciales() }}</span>
            </div>
            <div class="space-y-1">
              <p class="text-[11px] font-semibold uppercase tracking-widest text-slate-500">Resumen del personal</p>
              <h2 class="text-2xl font-bold text-slate-900 leading-tight">{{ personaNombre() }}</h2>
              <div class="flex flex-wrap items-center gap-2 text-sm text-slate-600">
                <span class="inline-flex items-center gap-1 rounded-md bg-slate-100 px-2.5 py-1 font-medium">
                  <svg class="h-4 w-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.657 0 3-1.343 3-3S13.657 5 12 5 9 6.343 9 8s1.343 3 3 3zM19 20a7 7 0 10-14 0h14z"/></svg>
                  Cedula: <span class="font-semibold">{{ persona()?.cedula || 'No registrada' }}</span>
                </span>
              </div>
              <div class="mt-2 flex flex-wrap items-center gap-2">
                <span [ngClass]="'inline-flex items-center gap-2 rounded-xl px-3 py-1.5 text-[12px] font-bold uppercase tracking-wide ' + tipoPersonaBadgeClass()">
                  {{ persona()?.tipoPersona || (persona()?.esMilitar ? 'Militar' : 'Dependiente/Civil') }}
                </span>
                <span class="inline-flex items-center gap-2 rounded-xl bg-slate-100 px-3 py-1.5 text-[12px] font-semibold text-slate-700">
                  {{ persona()?.provincia || 'Sin provincia' }}
                </span>
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2 text-xs text-slate-600">
            <button type="button" (click)="cerrar()"
              class="inline-flex items-center justify-center gap-2 rounded-lg border-2 border-slate-300 bg-white px-4 py-2.5 text-xs font-bold uppercase tracking-wide text-slate-700 shadow-sm transition-all hover:border-slate-400 hover:bg-slate-50 hover:shadow-md"
              [disabled]="cargando()">
              Cerrar
            </button>
          </div>
        </header>
      </article>

      <form [formGroup]="form" (ngSubmit)="onSubmit()"
        class="space-y-6 rounded-3xl border-2 border-slate-200 bg-white p-6 shadow-xl">
        <ng-container [ngSwitch]="pasoActual()">
          <!-- Paso 0 -->
          <section *ngSwitchCase="0" class="grid gap-4 md:grid-cols-2">
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Cedula *
              <input formControlName="cedula" type="text" maxlength="20" autocomplete="off" required
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring"
                [ngClass]="controlConError('cedula') ? 'border-red-400' : 'border-slate-300'" />
              <span *ngIf="controlConError('cedula')" class="mt-1 block text-xs text-red-600">
                {{ form.get('cedula')?.hasError('required') ? 'Este campo es obligatorio.' : '' }}
                {{ form.get('cedula')?.hasError('maxlength') ? 'Máximo 20 caracteres.' : '' }}
              </span>
            </label>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500 md:col-span-2">
              Apellidos y nombres *
              <input formControlName="apellidosNombres" type="text" maxlength="200" autocomplete="off" required
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring"
                [ngClass]="controlConError('apellidosNombres') ? 'border-red-400' : 'border-slate-300'"
                placeholder="Ej: PEREZ GARCIA JUAN CARLOS" />
              <span *ngIf="controlConError('apellidosNombres')" class="mt-1 block text-xs text-red-600">
                {{ form.get('apellidosNombres')?.hasError('required') ? 'Este campo es obligatorio.' : '' }}
                {{ form.get('apellidosNombres')?.hasError('maxlength') ? 'Máximo 200 caracteres.' : '' }}
              </span>
            </label>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Tipo de persona *
              <select formControlName="tipoPersona"
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring">
                <option *ngFor="let tipo of tipoPersonaOpciones" [value]="tipo">{{ tipo }}</option>
              </select>
            </label>
            <label class="flex items-center gap-2 text-xs font-semibold uppercase tracking-wide text-slate-500 mt-6">
              <input type="checkbox" formControlName="esMilitar"
                class="h-4 w-4 rounded border border-slate-300 text-slate-900 focus:ring-slate-900" />
              Es militar en servicio
            </label>
          </section>
          <!-- Paso 1 -->
          <section *ngSwitchCase="1" class="grid gap-4 md:grid-cols-2">
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Fecha de nacimiento
              <div class="relative mt-1">
                <input formControlName="fechaNacimiento" type="date" 
                  class="w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring border-slate-300"
                  placeholder="YYYY-MM-DD" />
                <span class="absolute right-3 top-2.5 text-xs text-slate-400 pointer-events-none">
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                </span>
              </div>
              <p class="mt-1 text-xs text-slate-500">La edad se calculará automáticamente</p>
            </label>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Edad
              <input formControlName="edad" type="number" min="0" max="120" readonly
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm bg-slate-50 border-slate-300"
                [ngClass]="controlConError('edad') ? 'border-red-400' : ''"
                placeholder="Se calcula automáticamente" />
              <span *ngIf="controlConError('edad')" class="mt-1 block text-xs text-red-600">La edad debe ser un numero mayor o igual a 0.</span>
              <p class="mt-1 text-xs text-slate-500">Campo calculado automáticamente</p>
            </label>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Sexo *
              <select formControlName="sexo"
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring">
                <option *ngFor="let sexo of sexoOpciones" [value]="sexo">{{ sexo }}</option>
              </select>
            </label>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Estado civil
              <select formControlName="estadoCivil"
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring">
                <option value="">Selecciona...</option>
                <option *ngFor="let estado of estadoCivilOpciones" [value]="estado">{{ estado }}</option>
              </select>
            </label>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Etnia
              <select formControlName="etnia"
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring">
                <option value="">Selecciona...</option>
                <option *ngFor="let etnia of etniaOpciones" [value]="etnia">{{ etnia }}</option>
              </select>
            </label>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Numero de hijos
              <input formControlName="numeroHijos" type="number" min="0"
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring"
                [ngClass]="controlConError('numeroHijos') ? 'border-red-400' : ''" />
              <span *ngIf="controlConError('numeroHijos')" class="mt-1 block text-xs text-red-600">Ingrese un valor igual o mayor a 0.</span>
            </label>
            <div *ngIf="edadOFechaInvalido()" class="md:col-span-2 rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-xs text-amber-800">
              <div class="flex items-center gap-2">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                </svg>
                Proporciona la fecha de nacimiento para calcular la edad automáticamente.
              </div>
            </div>
          </section>
          <!-- Paso 2 -->
          <section *ngSwitchCase="2" class="grid gap-4 md:grid-cols-2">
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500 md:col-span-2">
              Ocupacion
              <input formControlName="ocupacion" type="text" maxlength="150" autocomplete="off"
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring"
                placeholder="Ej: Oficial, Administrativo, etc." />
            </label>
            <div class="md:col-span-2 grid grid-cols-2 gap-4">
              <label class="flex items-center gap-2 text-xs font-semibold uppercase tracking-wide text-slate-500">
                <input type="checkbox" formControlName="servicioActivo"
                  class="h-4 w-4 rounded border border-slate-300 text-slate-900 focus:ring-slate-900" />
                Servicio activo
              </label>
              <label class="flex items-center gap-2 text-xs font-semibold uppercase tracking-wide text-slate-500">
                <input type="checkbox" formControlName="servicioPasivo"
                  class="h-4 w-4 rounded border border-slate-300 text-slate-900 focus:ring-slate-900" />
                Servicio pasivo
              </label>
            </div>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Seguro
              <select formControlName="seguro"
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring">
                <option value="">Selecciona...</option>
                <option *ngFor="let seguro of seguroOpciones" [value]="seguro">{{ seguro }}</option>
              </select>
            </label>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Grado
              <select formControlName="grado"
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring">
                <option value="">Selecciona...</option>
                <option *ngFor="let grado of gradoOpciones" [value]="grado">{{ grado }}</option>
              </select>
            </label>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Especialidad
              <input formControlName="especialidad" type="text" maxlength="150" autocomplete="off"
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring"
                placeholder="Ej: Infantería, Logística, etc." />
            </label>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Unidad militar
              <input formControlName="unidadMilitar" type="text" maxlength="150" autocomplete="off"
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring"
                placeholder="Ej: Batallón de Infantería No. 1" />
            </label>
          </section>
          <!-- Paso 3 -->
          <section *ngSwitchCase="3" class="grid gap-4 md:grid-cols-2">
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Provincia
              <select formControlName="provincia"
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring">
                <option value="">Selecciona...</option>
                <option *ngFor="let provincia of provinciaOpciones" [value]="provincia">{{ provincia }}</option>
              </select>
            </label>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Canton
              <select formControlName="canton"
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring"
                [disabled]="!cantonOpciones().length">
                <option value="">Selecciona...</option>
                <option *ngFor="let canton of cantonOpciones()" [value]="canton">{{ canton }}</option>
              </select>
            </label>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Parroquia
              <select formControlName="parroquia"
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring"
                [disabled]="!parroquiaOpciones().length">
                <option value="">Selecciona...</option>
                <option *ngFor="let parroquia of parroquiaOpciones()" [value]="parroquia">{{ parroquia }}</option>
              </select>
            </label>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Barrio o sector
              <input formControlName="barrioSector" type="text" maxlength="150" autocomplete="off"
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring"
                placeholder="Ej: Centro, La Floresta, etc." />
            </label>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Telefono
              <input formControlName="telefono" type="text" maxlength="20" autocomplete="off"
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring"
                placeholder="Ej: 022345678" />
            </label>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              Celular
              <input formControlName="celular" type="text" maxlength="20" autocomplete="off"
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring"
                placeholder="Ej: 0999999999" />
            </label>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500 md:col-span-2">
              Email
              <input formControlName="email" type="email" maxlength="200" autocomplete="off"
                class="mt-1 w-full rounded-md border px-3 py-2 text-sm focus:border-slate-900 focus:outline-none focus:ring"
                [ngClass]="controlConError('email') ? 'border-red-400' : ''"
                placeholder="Ej: juan.perez@ejemplo.com" />
              <span *ngIf="controlConError('email')" class="mt-1 block text-xs text-red-600">Ingresa un correo electronico valido.</span>
            </label>
            <label class="flex items-center gap-2 text-xs font-semibold uppercase tracking-wide text-slate-500 md:col-span-2 mt-2">
              <input type="checkbox" formControlName="activo"
                class="h-4 w-4 rounded border border-slate-300 text-slate-900 focus:ring-slate-900" />
              Registro activo
            </label>
          </section>
        </ng-container>

        <footer class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex flex-wrap gap-3">
            <button *ngIf="pasoActual() > 0" type="button" (click)="retroceder()"
              class="rounded-md border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100"
              [disabled]="cargando()">
              Anterior
            </button>
            <button *ngIf="!esUltimoPaso()" type="submit"
              class="rounded-md bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-slate-700 transition disabled:opacity-60 disabled:cursor-not-allowed"
              [disabled]="cargando()">
              {{ cargando() ? 'Verificando...' : 'Continuar' }}
            </button>
            <button *ngIf="esUltimoPaso()" type="submit"
              class="rounded-md bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-emerald-500 transition disabled:opacity-60 disabled:cursor-not-allowed"
              [disabled]="cargando()">
              {{ cargando() ? 'Guardando...' : botonTexto() }}
            </button>
          </div>
          <div class="flex flex-wrap gap-3">
            <button *ngIf="esEdicion()" type="button" (click)="eliminar()"
              class="rounded-md border border-red-300 px-4 py-2 text-sm font-semibold text-red-700 transition hover:bg-red-50 disabled:opacity-60 disabled:cursor-not-allowed"
              [disabled]="cargando()">
              Eliminar
            </button>
            <button type="button" (click)="cerrar()"
              class="rounded-md border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100"
              [disabled]="cargando()">
              Cerrar
            </button>
          </div>
        </footer>
      </form>
    </section>
  </div>
</div>