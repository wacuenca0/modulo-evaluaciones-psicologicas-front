<section class="space-y-8">
  <h1 class="text-2xl font-bold mb-4">Historial personal</h1>
  <div *ngFor="let ficha of fichas">
    <article class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm hover:shadow-md transition-shadow mb-4">
      <header class="mb-3 flex items-start justify-between gap-4">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Evaluación</p>
          <p class="text-lg font-semibold text-slate-900">{{ ficha.numeroFicha || '—' }}</p>
        </div>
        <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-600">
          {{ ficha.estadoFicha || ficha.condicionClinica || 'Activa' }}
        </span>
        <!-- Botón solo para fichas en seguimiento -->
        <ng-container *ngIf="(ficha.estadoFicha || ficha.condicionClinica || '').toLowerCase().includes('seguimiento')">
          <button type="button"
            class="ml-2 rounded bg-blue-600 text-white px-3 py-1 text-xs font-semibold hover:bg-blue-700 transition"
            (click)="abrirSeguimientoModal(ficha.id)">
            Programar seguimiento
          </button>
        </ng-container>
      </header>
      <dl class="space-y-2 text-sm text-slate-600">
        <div class="flex items-start justify-between gap-4">
          <dt class="font-semibold text-slate-700">Fecha</dt>
          <dd>{{ ficha.fechaEvaluacion }}</dd>
        </div>
        <div class="flex items-start justify-between gap-4">
          <dt class="font-semibold text-slate-700">Diagnóstico</dt>
          <dd class="text-right">{{ ficha.diagnosticoDescripcion }}</dd>
        </div>
        <div class="flex items-start justify-between gap-4">
          <dt class="font-semibold text-slate-700">Psicólogo</dt>
          <dd>{{ ficha.psicologoNombre || 'No asignado' }}</dd>
        </div>
      </dl>
    </article>
  </div>
  <!-- Modal de seguimiento -->
  <app-programar-seguimiento-modal
    *ngIf="mostrarModalSeguimiento"
    [show]="mostrarModalSeguimiento"
    [psicologoActual]="{ 
      id: seguimientoFicha?.psicologoId ?? null, 
      nombre: seguimientoFicha?.psicologoNombre ?? 'Psicólogo no asignado' 
    }"
    [pacienteSeleccionado]="{
      id: persona()?.id ?? 0,
      apellidosNombres: personaNombre(),
      cedula: persona()?.cedula ?? '',
      nombres: persona()?.nombres ?? '',
      apellidos: persona()?.apellidos ?? '',
      grado: persona()?.grado ?? '',
      unidad: persona()?.unidad ?? ''
    }"
    [formModel]="{
      fichaPsicologicaId: seguimientoFicha?.fichaId ?? null,
      psicologoId: seguimientoFicha?.psicologoId ?? null,
      fechaAtencion: new Date().toISOString().split('T')[0],
      horaInicio: '09:00',
      horaFin: '10:00',
      tipoAtencion: 'PRESENCIAL',
      tipoConsulta: 'SEGUIMIENTO',
      motivoConsulta: '',
      estado: 'PROGRAMADA'
    }"
    [cargandoAccion]="seguimientoCargando"
    [error]="seguimientoError"
    [mensajeExito]="seguimientoMensajeExito"
    (cancelar)="cerrarModalSeguimiento()"
    (guardar)="guardarSeguimiento()"
    (asignarPaciente)="asignarPaciente($event)">
  </app-programar-seguimiento-modal>
</section>
