<!DOCTYPE html>
<section class="atenciones-psicologicas">
  <!-- Header Principal -->
  <header class="atenciones-header">
    <div class="header-container">
      <div class="header-text">
        <h1 class="header-title">Gestión de Atenciones Psicológicas</h1>
        <p class="header-subtitle">Administra consultas, seguimientos y programaciones psicológicas</p>
      </div>
      <div class="header-actions">
        <div class="action-buttons">
          <button class="btn btn-primary btn-icon" (click)="abrirModalCrear('ABIERTA')">
            <svg class="btn-icon-svg" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
            </svg>
            <span>Nueva Atención</span>
          </button>
          <button class="btn btn-secondary btn-icon" (click)="programarAtencion()">
            <svg class="btn-icon-svg" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <span>Programar</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Panel de Filtros -->
  <div class="filtros-panel">
    <div class="filtros-header">
      <h3>Filtros de Búsqueda</h3>
      <p>Especifica los criterios para encontrar atenciones</p>
    </div>
    <div class="filtros-grid">
      <!-- Estado -->
      <div class="filtro-group">
        <label for="filtroEstado" class="filtro-label">Estado</label>
        <select id="filtroEstado" class="filtro-select" [ngModel]="filtroEstado()" (ngModelChange)="filtroEstado.set($event); cargarAtencionesFiltradas()">
          <option value="TODAS">Todas las atenciones</option>
          <option *ngFor="let estado of estadosFiltrados()" [value]="estado">
            {{estadosConfig[estado]?.label || estado}}
          </option>
        </select>
      </div>
      <!-- Nombre del Paciente -->
      <div class="filtro-group">
        <label for="filtroNombrePaciente" class="filtro-label">Paciente</label>
        <input type="text" id="filtroNombrePaciente" placeholder="Buscar por nombre..." class="filtro-input" [ngModel]="filtroNombrePaciente()" (ngModelChange)="filtroNombrePaciente.set($event); cargarAtencionesFiltradas()">
      </div>
      <!-- Fecha Específica -->
      <div class="filtro-group">
        <label for="filtroFecha" class="filtro-label">Fecha</label>
        <input type="date" id="filtroFecha" class="filtro-input" [ngModel]="filtroFecha()" (ngModelChange)="filtroFecha.set($event); cargarAtencionesFiltradas()">
      </div>
      <!-- Filtro Hoy -->
      <div class="filtro-group filtro-checkbox">
        <div class="checkbox-container">
          <input type="checkbox" id="filtroHoy" class="checkbox-input" [ngModel]="filtroHoy()" (ngModelChange)="filtroHoy.set($event); cargarAtencionesFiltradas()">
          <label for="filtroHoy" class="checkbox-label">Solo atenciones de hoy</label>
        </div>
      </div>
      <!-- Tamaño de Página -->
      <div class="filtro-group">
        <label for="tamanioPagina" class="filtro-label">Registros por página</label>
        <select id="tamanioPagina" class="filtro-select" [ngModel]="size()" (ngModelChange)="size.set($event); cambiarTamanioPagina($event)">
          <option value="5">5 registros</option>
          <option value="10">10 registros</option>
          <option value="20">20 registros</option>
          <option value="50">50 registros</option>
        </select>
      </div>
    </div>
    <div class="filtros-footer">
      <div class="resultados-info">
        Mostrando <span class="info-destacado">{{getAtencionStart()}}-{{getAtencionEnd()}}</span> de <span class="info-destacado">{{totalElements()}}</span> atenciones
      </div>
      <div class="filtros-acciones">
        <button class="btn btn-outline" (click)="limpiarFiltros()">Limpiar filtros</button>
      </div>
    </div>
  </div>

  <!-- Lista de Atenciones -->
  <app-atenciones-lista
    [atenciones]="atenciones()"
    (verDetalle)="abrirDetalleModal($event)"
    (finalizar)="abrirFinalizarModal($event)"
    (cancelar)="cancelarAtencion($event)"
    (noAsistio)="marcarNoAsistio($event)"
    (reprogramar)="reprogramarAtencion($event)"
  ></app-atenciones-lista>

  <!-- Modal Detalle Atención -->
  @if (showDetalleModal()) {
    <app-atencion-detalle
      [show]="showDetalleModal()"
      [atencionId]="detalleAtencionId()"
      (cerrar)="cerrarDetalleModal()"
    ></app-atencion-detalle>
  }

  <!-- Modal Finalizar Atención -->
  @if (showFinalizarModal()) {
    <app-finalizar-atencion-modal
      [open]="showFinalizarModal()"
      (closed)="cerrarFinalizarModal()"
      (finalizar)="onFinalizarAtencion($event)"
    ></app-finalizar-atencion-modal>
  }

  <!-- Modal Cancelar Atención -->
  @if (showCancelarModal()) {
    <div class="modal-overlay" (click)="cerrarCancelarModal()">
      <div class="modal-container modal-sm" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Cancelar atención</h3>
        </div>
        <div class="modal-body">
          <label>Razón de cancelación</label>
          <input type="text" [(ngModel)]="razonCancelacion" class="form-input" />
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="cerrarCancelarModal()">Cerrar</button>
          <button class="btn btn-danger" (click)="onCancelarAtencion()">Cancelar atención</button>
        </div>
      </div>
    </div>
  }

  <!-- Modal No Asistió -->
  @if (showNoAsistioModal()) {
    <div class="modal-overlay" (click)="cerrarNoAsistioModal()">
      <div class="modal-container modal-sm" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Marcar como No Asistió</h3>
        </div>
        <div class="modal-body">
          <p>¿Confirmar que el paciente no asistió?</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="cerrarNoAsistioModal()">Cerrar</button>
          <button class="btn btn-warning" (click)="onNoAsistioAtencion()">Confirmar</button>
        </div>
      </div>
    </div>
  }

  <!-- Modal Reprogramar Atención -->
  @if (showReprogramarModal()) {
    <div class="modal-overlay" (click)="cerrarReprogramarModal()">
      <div class="modal-container modal-sm" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Reprogramar atención</h3>
        </div>
        <div class="modal-body">
          <label>Nueva fecha</label>
          <input type="date" [(ngModel)]="nuevaFechaReprogramar" class="form-input" />
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="cerrarReprogramarModal()">Cerrar</button>
          <button class="btn btn-secondary" (click)="onReprogramarAtencion()">Reprogramar</button>
        </div>
      </div>
    </div>
  }

  <!-- Modal de Crear/Editar Atención -->
  @if (showModal()) {
    <div class="modal-overlay atencion-modal" (click)="cerrarModal()" (keydown)="onModalKeyDown($event)">
      <div class="modal-container modal-lg" (click)="$event.stopPropagation()" (keydown)="onModalKeyDown($event)">
        <!-- Header -->
        <div class="modal-header">
          <div class="modal-header-contenido">
            <h3 class="modal-titulo">{{modoEdicion() ? 'Editar' : 'Crear Nueva'}} Atención</h3>
            <p class="modal-subtitulo">Complete la información de la atención psicológica</p>
          </div>
          <button class="modal-cerrar" (click)="cerrarModal()">
            <svg viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <!-- Contenido -->
        <div class="modal-body">
          @if (error()) {
            <div class="mensaje-error-modal">{{error()}}</div>
          }
          @if (mensajeExito()) {
            <div class="mensaje-exito-modal">{{mensajeExito()}}</div>
          }
          <form class="formulario-atencion" (ngSubmit)="guardarAtencion()" #atencionForm="ngForm">
            <!-- Información Básica -->
            <div class="form-seccion">
              <h4 class="seccion-titulo">Información Básica</h4>
              <div class="form-grid">
                <!-- Fila 1: Paciente | Fecha de atención -->
                <div class="form-group">
                  <label for="pacienteAutocomplete" class="form-label requerido">Paciente</label>
                  <app-paciente-autocomplete id="pacienteAutocomplete" (pacienteSeleccionado)="asignarPaciente($event)"></app-paciente-autocomplete>
                  @if (pacienteSeleccionado) {
                    <div class="paciente-seleccionado-card">
                      <svg class="check-icon" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                      </svg>
                      <div class="paciente-info">
                        <span class="paciente-nombre">{{pacienteSeleccionado.nombres}} {{pacienteSeleccionado.apellidos}}</span>
                        <span class="paciente-datos">C.I. {{pacienteSeleccionado.cedula}} • {{pacienteSeleccionado.grado}}</span>
                      </div>
                    </div>
                  }
                </div>
                <div class="form-group">
                  <label for="fechaAtencion" class="form-label requerido">Fecha de atención</label>
                  <input type="date" name="fechaAtencion" required id="fechaAtencion" class="form-input" [(ngModel)]="formModel.fechaAtencion">
                </div>
                <!-- Fila 2: Horario | Tipo de consulta -->
                <div class="form-group">
                  <label for="horaInicio" class="form-label requerido">Horario</label>
                  <div class="horario-inputs">
                    <input type="time" name="horaInicio" required id="horaInicio" class="form-input hora-input" [(ngModel)]="formModel.horaInicio">
                    <span class="horario-separador">-</span>
                    <input type="time" name="horaFin" required id="horaFin" class="form-input hora-input" [(ngModel)]="formModel.horaFin">
                  </div>
                </div>
                <div class="form-group">
                  <label for="tipoConsulta" class="form-label requerido">Tipo de consulta</label>
                  <select name="tipoConsulta" required id="tipoConsulta" class="form-select" [(ngModel)]="formModel.tipoConsulta">
                    <option *ngFor="let tipo of tiposConsulta()" [value]="tipo.valor">{{tipo.label}}</option>
                  </select>
                </div>
                <!-- Fila 3: Modalidad (ocupa las dos columnas) -->
                <div class="form-group" style="grid-column: 1/3;">
                  <label for="tipoAtencion" class="form-label requerido">Modalidad</label>
                  <select name="tipoAtencion" required id="tipoAtencion" class="form-select" [(ngModel)]="formModel.tipoAtencion">
                    <option *ngFor="let tipo of tiposAtencion()" [value]="tipo.valor">{{tipo.label}}</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Motivo de Consulta -->
            <div class="form-seccion">
              <label for="motivoConsulta" class="form-label requerido">Motivo de consulta</label>
              <textarea name="motivoConsulta" required rows="3" id="motivoConsulta" class="form-textarea" placeholder="Describa el motivo principal de la consulta..." [(ngModel)]="formModel.motivoConsulta"></textarea>
            </div>
            
            <!-- Diagnósticos CIE-10 -->
            <div class="form-seccion">
              <h4 class="seccion-titulo">Diagnósticos CIE-10</h4>
              <div class="diagnosticos-container">
                <!-- Búsqueda -->
                <div class="diagnosticos-busqueda">
                  <input type="text" name="cie10Search" placeholder="Buscar por código o nombre..." class="busqueda-input" [(ngModel)]="cie10SearchTerm">
                  @if (cie10SearchTerm() && cie10SearchTerm().length >= 2) {
                    <div class="busqueda-resultados">
                      @if (cargandoDiagnosticos()) {
                        <div class="instruccion-busqueda">Buscando...</div>
                      } @else if (diagnosticosFiltrados().length === 0) {
                        <div class="instruccion-busqueda">No se encontraron diagnósticos</div>
                      } @else {
                        <div class="resultados-lista">
                          @for (diagnostico of diagnosticosFiltrados(); track diagnostico.id) {
                            <div class="resultado-item" (click)="toggleDiagnostico(diagnostico.id!)" (keydown)="onDiagnosticoKeyDown($event, diagnostico.id!)" [class.seleccionado]="formModel.diagnosticoIds.includes(diagnostico.id!)">
                              <div class="resultado-info">
                                <span class="resultado-codigo">{{diagnostico.codigo}}</span>
                                <span class="resultado-nombre">{{diagnostico.nombre}}</span>
                              </div>
                              @if (formModel.diagnosticoIds.includes(diagnostico.id!)) {
                                <svg class="check-icon" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                                </svg>
                              }
                            </div>
                          }
                        </div>
                      }
                    </div>
                  }
                </div>
                <!-- Seleccionados -->
                @if (formModel.diagnosticoIds && formModel.diagnosticoIds.length > 0) {
                  <div class="diagnosticos-seleccionados">
                    <h5 class="seleccionados-titulo">Diagnósticos seleccionados</h5>
                    <div class="seleccionados-lista">
                      @for (diagnosticoId of formModel.diagnosticoIds; track diagnosticoId) {
                        @let diagnostico = getDiagnosticoCIE10ById(diagnosticoId);
                        @if (diagnostico) {
                          <div class="diagnostico-seleccionado">
                            <div class="diagnostico-contenido">
                              <span class="diagnostico-codigo">{{diagnostico.codigo}}</span>
                              <span class="diagnostico-nombre">{{diagnostico.nombre}}</span>
                            </div>
                            <button type="button" class="diagnostico-eliminar" (click)="toggleDiagnostico(diagnosticoId)">
                              <svg viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                              </svg>
                            </button>
                          </div>
                        }
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
            
            <!-- Información Clínica -->
            <div class="form-seccion">
              <h4 class="seccion-titulo">Información Clínica</h4>
              <div class="form-columna" style="display: flex; flex-direction: column; gap: 18px;">
                <div class="form-group">
                  <label for="anamnesis" class="form-label">Anamnesis</label>
                  <textarea name="anamnesis" rows="4" id="anamnesis" class="form-textarea" placeholder="Historia clínica del paciente..." [(ngModel)]="formModel.anamnesis"></textarea>
                </div>
                <div class="form-group">
                  <label for="examenMental" class="form-label">Examen mental</label>
                  <textarea name="examenMental" rows="3" id="examenMental" class="form-textarea" placeholder="Observaciones del estado mental..." [(ngModel)]="formModel.examenMental"></textarea>
                </div>
                <div class="form-group">
                  <label for="impresionDiagnostica" class="form-label">Impresión diagnóstica</label>
                  <textarea name="impresionDiagnostica" rows="3" id="impresionDiagnostica" class="form-textarea" placeholder="Lo que observa el psicólogo..." [(ngModel)]="formModel.impresionDiagnostica"></textarea>
                </div>
                <div class="form-group">
                  <label for="planIntervencion" class="form-label">Plan de intervención</label>
                  <textarea name="planIntervencion" rows="3" id="planIntervencion" class="form-textarea" placeholder="Qué se va a hacer..." [(ngModel)]="formModel.planIntervencion"></textarea>
                </div>
                <div class="form-group">
                  <label for="recomendaciones" class="form-label">Recomendaciones</label>
                  <textarea name="recomendaciones" rows="3" id="recomendaciones" class="form-textarea" placeholder="Recomendaciones para el paciente..." [(ngModel)]="formModel.recomendaciones"></textarea>
                </div>
                <div class="form-group">
                  <label for="derivacion" class="form-label">Derivación</label>
                  <input type="text" name="derivacion" id="derivacion" class="form-input" placeholder="Si deriva a otro especialista..." [(ngModel)]="formModel.derivacion">
                </div>
              </div>
            </div>
            
            <!-- Seguimiento -->
            <div class="form-seccion">
              <h4 class="seccion-titulo">Seguimiento</h4>
              <div class="form-grid">
                <div class="form-group">
                  <label for="proximaCita" class="form-label">Próxima cita</label>
                  <input type="date" name="proximaCita" id="proximaCita" class="form-input" [(ngModel)]="formModel.proximaCita">
                </div>
                <div class="form-group full-width">
                  <label for="observacionesProximaCita" class="form-label">Observaciones</label>
                  <textarea name="observacionesProximaCita" rows="2" id="observacionesProximaCita" class="form-textarea" placeholder="Observaciones para la próxima cita..." [(ngModel)]="formModel.observacionesProximaCita"></textarea>
                </div>
              </div>
            </div>
            
            <!-- Footer del Formulario -->
            <div class="form-footer">
              <div class="form-acciones">
                <button type="button" class="btn btn-outline" (click)="cerrarModal()">Cancelar</button>
                
                @if (!modoEdicion() && !modoProgramada()) {
                  <button type="button" class="btn btn-warning" (click)="guardarEnCurso()" [disabled]="cargandoAccion()">
                    @if (cargandoAccion()) {
                      <span class="cargando-spinner"></span> Guardando...
                    } @else {
                      Guardar en curso
                    }
                  </button>
                }
                
                <button type="submit" class="btn btn-primary" [disabled]="cargandoAccion()">
                  @if (cargandoAccion()) {
                    <span class="cargando-spinner"></span> Procesando...
                  } @else {
                    {{modoEdicion() ? 'Actualizar' : modoProgramada() ? 'Programar' : 'Crear'}} Atención
                  }
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  }

  <!-- Modal Eliminar -->
  @if (showEliminarModal()) {
    <div class="modal-overlay" (click)="cerrarModalEliminar()" (keydown)="onModalKeyDown($event)">
      <div class="modal-container modal-sm" (click)="$event.stopPropagation()" (keydown)="onModalKeyDown($event)">
        <!-- Header -->
        <div class="modal-header">
          <div class="modal-header-contenido">
            <h3 class="modal-titulo">Confirmar Eliminación</h3>
            <p class="modal-subtitulo">¿Está seguro de eliminar esta atención?</p>
          </div>
          <button class="modal-cerrar" (click)="cerrarModalEliminar()">
            <svg viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <!-- Contenido -->
        <div class="modal-body">
          <div class="advertencia-eliminar">
            <svg class="advertencia-icono" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" 
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.998-.833-2.732 0L4.342 16.5c-.77.833.192 2.5 1.732 2.5z"/>
            </svg>
            <div class="advertencia-contenido">
              <h4>Advertencia</h4>
              <p>Esta acción eliminará permanentemente la atención y todos sus datos asociados. Esta acción no se puede deshacer.</p>
            </div>
          </div>
        </div>
        
        <!-- Footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-outline" (click)="cerrarModalEliminar()">
            Cancelar
          </button>
          
          <button type="button" class="btn btn-danger" (click)="confirmarEliminarAtencion()" [disabled]="cargandoAccion()">
            @if (cargandoAccion()) {
              <span class="cargando-spinner"></span> Procesando...
            } @else {
              Eliminar Permanentemente
            }
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Modal Programar Atención -->
  @if (showProgramarModal()) {
    <app-programar-atencion-modal 
      [show]="showProgramarModal()"
      [cargandoAccion]="programarCargandoAccion()"
      [error]="programarError()"
      [mensajeExito]="programarMensajeExito()"
      [psicologoActual]="psicologoActual()"
      [tiposConsulta]="tiposConsulta()"
      [tiposAtencion]="tiposAtencion()"
      [pacienteSeleccionado]="programarPacienteSeleccionado"
      [formModel]="programarFormModel"
      (cancelar)="cerrarProgramarModal()"
      (guardar)="guardarAtencionProgramada()"
      (asignarPaciente)="asignarPacienteProgramar($event)"
    ></app-programar-atencion-modal>
  }

  <!-- Modal Programar Seguimiento -->
  @if (showProgramarSeguimientoModal()) {
    <app-programar-seguimiento-modal 
      [show]="showProgramarSeguimientoModal()"
      [cargandoAccion]="programarSeguimientoCargandoAccion()"
      [error]="programarSeguimientoError()"
      [mensajeExito]="programarSeguimientoMensajeExito()"
      [psicologoActual]="psicologoActual()"
      [diagnosticos]="todosDiagnosticosCIE10()"
      [pacienteSeleccionado]="programarPacienteSeleccionado"
      [formModel]="programarSeguimientoFormModel"
      (cancelar)="cerrarProgramarSeguimientoModal()"
      (guardar)="guardarSeguimientoProgramado()"
      (asignarPaciente)="asignarPacienteProgramar($event)"
    ></app-programar-seguimiento-modal>
  }

  <!-- Modal Detalle -->
  @if (showDetalleModal()) {
    <app-atencion-detalle
      [atencionId]="detalleAtencionId()"
      (closeModal)="cerrarDetalleModal()">
    </app-atencion-detalle>
  }
</section>