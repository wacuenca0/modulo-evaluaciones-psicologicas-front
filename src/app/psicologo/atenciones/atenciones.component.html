<!DOCTYPE html>
<section class="atenciones-psicologicas">
  <!-- Header Principal -->
  <header class="atenciones-header">
    <div class="header-container">
      <div class="header-text">
        <h1 class="header-title">Gestión de Atenciones Psicológicas</h1>
        <p class="header-subtitle">Administra consultas, seguimientos y programaciones psicológicas</p>
      </div>
      <div class="header-actions">
        <div class="action-buttons">
          <button class="btn btn-primary btn-icon" (click)="abrirModalCrear('ABIERTA')">
            <svg class="btn-icon-svg" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
            </svg>
            <span>Nueva Atención</span>
          </button>
          <button class="btn btn-secondary btn-icon" (click)="programarAtencion()">
            <svg class="btn-icon-svg" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <span>Programar Atención</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Panel de Filtros -->
  <div class="filtros-panel">
    <div class="filtros-header">
      <h3>Filtros de Búsqueda</h3>
      <p>Especifica los criterios para encontrar atenciones</p>
    </div>
    <div class="filtros-grid">
      <!-- Estado -->
      <div class="filtro-group">
        <label for="filtroEstado" class="filtro-label">Estado</label>
        <select id="filtroEstado" class="filtro-select" [ngModel]="filtroEstado()" (ngModelChange)="filtroEstado.set($event); cargarAtencionesFiltradas()">
          <option value="TODAS">Todas las atenciones</option>
          <option *ngFor="let estado of estadosFiltrados()" [value]="estado">
            {{estadosConfig[estado]?.label || estado}}
          </option>
        </select>
      </div>
      <!-- Nombre del Paciente -->
      <div class="filtro-group">
        <label for="filtroNombrePaciente" class="filtro-label">Paciente</label>
        <input type="text" id="filtroNombrePaciente" placeholder="Buscar por nombre..." class="filtro-input" [ngModel]="filtroNombrePaciente()" (ngModelChange)="filtroNombrePaciente.set($event); cargarAtencionesFiltradas()">
      </div>
      <!-- Fecha Específica -->
      <div class="filtro-group">
        <label for="filtroFecha" class="filtro-label">Fecha</label>
        <input type="date" id="filtroFecha" class="filtro-input" [ngModel]="filtroFecha()" (ngModelChange)="filtroFecha.set($event); cargarAtencionesFiltradas()">
      </div>
      <!-- Filtro Hoy -->
      <div class="filtro-group filtro-checkbox">
        <div class="checkbox-container">
          <input type="checkbox" id="filtroHoy" class="checkbox-input" [ngModel]="filtroHoy()" (ngModelChange)="filtroHoy.set($event); cargarAtencionesFiltradas()">
          <label for="filtroHoy" class="checkbox-label">Solo atenciones de hoy</label>
        </div>
      </div>
      <!-- Tamaño de Página -->
      <div class="filtro-group">
        <label for="tamanioPagina" class="filtro-label">Registros por página</label>
        <select id="tamanioPagina" class="filtro-select" [ngModel]="size()" (ngModelChange)="size.set($event); cambiarTamanioPagina($event)">
          <option value="5">5 registros</option>
          <option value="10">10 registros</option>
          <option value="20">20 registros</option>
          <option value="50">50 registros</option>
        </select>
      </div>
    </div>
    <div class="filtros-footer">
      <div class="resultados-info">
        Mostrando <span class="info-destacado">{{getAtencionStart()}}-{{getAtencionEnd()}}</span> de <span class="info-destacado">{{totalElements()}}</span> atenciones
      </div>
      <div class="filtros-acciones">
        <button class="btn btn-outline" (click)="limpiarFiltros()">Limpiar filtros</button>
      </div>
    </div>
  </div>

  <!-- Lista de Atenciones -->
  <app-atenciones-lista
    [atenciones]="atenciones()"
    [resaltarId]="atencionResaltadaId()"
    (verDetalle)="abrirDetalleModal($event)"
    (verHistorial)="abrirHistorialCambios($event)"
    (finalizar)="abrirFinalizarModal($event)"
    (cancelar)="cancelarAtencion($event)"
    (noAsistio)="marcarNoAsistio($event)"
    (reprogramar)="reprogramarAtencion($event)">
  </app-atenciones-lista>
  <!-- Modal Detalle Atención -->
  @if (showDetalleModal()) {
    <app-atencion-detalle
      [show]="showDetalleModal()"
      [atencionId]="detalleAtencionId()"
      (cerrar)="cerrarDetalleModal()"
    ></app-atencion-detalle>
  }

  <!-- Modal Historial de Cambios -->
  @if (showHistorialModal()) {
    <div class="modal-overlay" (click)="cerrarHistorialModal()" (keydown)="onModalKeyDown($event)">
      <div class="modal-container modal-md" (click)="$event.stopPropagation()" (keydown)="onModalKeyDown($event)">
        <!-- Header -->
        <div class="modal-header">
          <div class="modal-header-contenido">
            <h3 class="modal-titulo">Historial de cambios</h3>
            <p class="modal-subtitulo">
              Revisa cómo ha ido cambiando el estado de esta atención en el tiempo.
            </p>
          </div>
          <button class="modal-cerrar" (click)="cerrarHistorialModal()">
            <svg viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <!-- Contenido -->
        <div class="modal-body">
          @if (cargandoHistorial()) {
            <div class="cargando-resultados">Cargando historial...</div>
          } @else {
            @if (historialError()) {
              <div class="mensaje-error-modal">{{historialError()}}</div>
            }

            @if (historialCambios().length === 0 && !historialError()) {
              <div class="sin-resultados">Esta atención aún no tiene cambios registrados.</div>
            } @else if (historialCambios().length > 0) {
              <div class="timeline">
                <div class="timeline-linea"></div>
                @for (cambio of historialCambios(); track cambio.id) {
                  <div class="timeline-item">
                    <div class="timeline-punto"
                      [ngClass]="{
                        'punto-programada': cambio.estado === 'PROGRAMADA',
                        'punto-reprogramada': cambio.estado === 'REPROGRAMADA',
                        'punto-finalizada': cambio.estado === 'FINALIZADA',
                        'punto-cancelada': cambio.estado === 'CANCELADA',
                        'punto-no_asistio': cambio.estado === 'NO_ASISTIO'
                      }"></div>

                    <div class="timeline-contenido">
                      <div class="timeline-header">
                        <div class="timeline-estado">
                          <svg class="estado-icono" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                          </svg>
                          <span class="estado-label"
                            [ngClass]="{
                              'programada': cambio.estado === 'PROGRAMADA',
                              'reprogramada': cambio.estado === 'REPROGRAMADA',
                              'finalizada': cambio.estado === 'FINALIZADA',
                              'cancelada': cambio.estado === 'CANCELADA',
                              'no-asistio': cambio.estado === 'NO_ASISTIO'
                            }">
                            {{ cambio.estado }}
                          </span>
                        </div>
                        <span class="historial-fecha">{{ cambio.fechaCambio | date:'short' }}</span>
                      </div>

                      <div class="timeline-metadata">
                        <div class="metadata-item">
                          <span class="metadata-label">Psicólogo</span>
                          <span class="metadata-valor">{{ cambio.psicologoNombres }} {{ cambio.psicologoApellidos }}</span>
                        </div>
                      </div>

                      @if (cambio.razonCambio) {
                        <div class="timeline-razon">
                          <span class="razon-label">
                            {{ cambio.estado === 'REPROGRAMADA' ? 'Motivo de reprogramación' : 'Razón del cambio' }}
                          </span>
                          <p class="razon-texto">{{ cambio.razonCambio }}</p>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          }
        </div>

        <!-- Footer -->
        <div class="modal-footer">
          <button
            type="button"
            (click)="cerrarHistorialModal()"
            class="modal-btn-secondary"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Modal Cancelar Atención -->
  @if (showCancelarModal()) {
    <div class="modal-overlay" (click)="cerrarCancelarModal()" (keydown)="onModalKeyDown($event)">
      <div class="modal-container modal-sm" (click)="$event.stopPropagation()" (keydown)="onModalKeyDown($event)">
        <div class="modal-header">
          <div class="modal-header-contenido">
            <h3 class="modal-titulo">Cancelar atención</h3>
            <p class="modal-subtitulo">
              Ingrese el motivo de cancelación. Esta acción no se puede deshacer.
            </p>
          </div>
          <button class="modal-cerrar" (click)="cerrarCancelarModal()">
            <svg viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label for="razonCancelacionModal" class="form-label requerido">Razón de cancelación</label>
            <textarea
              id="razonCancelacionModal"
              rows="3"
              class="form-textarea"
              [(ngModel)]="razonCancelacion"
              placeholder="Explique por qué se cancela la atención..."
            ></textarea>
          </div>
        </div>

        <div class="modal-footer border-t border-slate-200 pt-4 flex justify-end gap-3">
          <button
            type="button"
            (click)="cerrarCancelarModal()"
            class="modal-btn-secondary"
          >
            Cerrar
          </button>
          <button
            type="button"
            (click)="onCancelarAtencion()"
            class="modal-btn-primary"
          >
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Cancelar atención
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Modal Confirmación Acción Peligrosa (Cancelar, Finalizar, No asistió) -->
  @if (showConfirmAccionModal()) {
    <div class="modal-overlay" (click)="cancelarAccionPeligrosa()" (keydown)="onModalKeyDown($event)">
      <div class="modal-container modal-sm" (click)="$event.stopPropagation()" (keydown)="onModalKeyDown($event)">
        <!-- Header -->
        <div class="modal-header">
          <div class="modal-header-contenido">
            <h3 class="modal-titulo">Confirmar acción</h3>
            <p class="modal-subtitulo">
              Esta acción no se puede deshacer. ¿Está seguro de continuar?
            </p>
          </div>
          <button class="modal-cerrar" (click)="cancelarAccionPeligrosa()">
            <svg viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <!-- Contenido -->
        <div class="modal-body">
          <p class="text-sm text-slate-700">
            Se va a
            <strong>
              @if (accionPeligrosa === 'NO_ASISTIO') {
                marcar la atención como "NO ASISTIÓ".
              } @else if (accionPeligrosa === 'CANCELAR') {
                cancelar la atención seleccionada.
              } @else if (accionPeligrosa === 'FINALIZAR') {
                finalizar la atención seleccionada.
              } @else {
                aplicar la acción seleccionada.
              }
            </strong>
          </p>
        </div>

        <!-- Footer -->
        <div class="modal-footer">
          <button
            type="button"
            (click)="cancelarAccionPeligrosa()"
            class="modal-btn-secondary"
          >
            Volver
          </button>

          <button
            type="button"
            (click)="confirmarAccionPeligrosa()"
            class="modal-btn-primary"
          >
            Confirmar
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Modal No Asistió eliminado: acción directa desde el botón de la tarjeta -->

  <!-- Modal Reprogramar Atención -->
  @if (showReprogramarModal()) {
    <div class="modal-overlay" (click)="cerrarReprogramarModal()" (keydown)="onModalKeyDown($event)">
      <div class="modal-container modal-sm" (click)="$event.stopPropagation()" (keydown)="onModalKeyDown($event)">
        <div class="modal-header">
          <div class="modal-header-contenido">
            <h3 class="modal-titulo">Reprogramar atención</h3>
            <p class="modal-subtitulo">Actualice la fecha, horario y modalidad de la cita.</p>
          </div>
          <button class="modal-cerrar" (click)="cerrarReprogramarModal()">
            <svg viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label requerido" for="reprogramarFechaAtencion">Fecha de atención</label>
            <input id="reprogramarFechaAtencion" type="date" [(ngModel)]="reprogramarForm.fechaAtencion" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label requerido" for="reprogramarHoraInicio">Horario</label>
            <div class="horario-inputs">
              <input id="reprogramarHoraInicio" type="time" [(ngModel)]="reprogramarForm.horaInicio" class="form-input hora-input" />
              <span class="horario-separador">-</span>
              <input id="reprogramarHoraFin" type="time" [(ngModel)]="reprogramarForm.horaFin" class="form-input hora-input" />
            </div>
          </div>
          <div class="form-group">
            <label class="form-label requerido" for="reprogramarTipoAtencion">Modalidad</label>
            <select id="reprogramarTipoAtencion" class="form-select" [(ngModel)]="reprogramarForm.tipoAtencion">
              <option *ngFor="let tipo of tiposAtencion()" [value]="tipo.valor">{{ tipo.label }}</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label requerido" for="reprogramarMotivo">Motivo de reprogramación</label>
            <textarea id="reprogramarMotivo" rows="3" class="form-textarea" [(ngModel)]="reprogramarForm.motivoReprogramacion" placeholder="Explique por qué se reprograma la atención..."></textarea>
          </div>
        </div>
        <div class="modal-footer border-t border-slate-200 pt-4 flex justify-end gap-3">
          <button type="button" (click)="cerrarReprogramarModal()"
                  class="modal-btn-secondary">
            Cerrar
          </button>
          <button type="button" (click)="onReprogramarAtencion()" [disabled]="cargandoAccion()"
                  [class]="'modal-btn-primary ' + (cargandoAccion() ? 'opacity-60 cursor-not-allowed' : '')">
            @if (cargandoAccion()) {
              <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Reprogramando...
            } @else {
              <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582M5 19a9 9 0 1 0 3-14.197"/>
              </svg>
              Reprogramar
            }
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Modal de Crear/Editar Atención -->
  @if (showModal()) {
    <div class="modal-overlay atencion-modal" (click)="cerrarModal()" (keydown)="onModalKeyDown($event)">
      <div class="modal-container modal-lg" (click)="$event.stopPropagation()" (keydown)="onModalKeyDown($event)">
        <!-- Header -->
        <div class="modal-header">
          <div class="modal-header-contenido">
            <h3 class="modal-titulo">
              {{ modoFinalizar() 
                  ? 'Finalizar atención programada'
                  : (modoEdicion() ? 'Editar' : 'Crear Nueva') + ' Atención' }}
            </h3>
            <p class="modal-subtitulo">
              {{ modoFinalizar() 
                  ? 'Complete la información clínica para finalizar la atención'
                  : 'Complete la información de la atención psicológica' }}
            </p>
          </div>
          <button class="modal-cerrar" (click)="cerrarModal()">
            <svg viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <!-- Contenido -->
        <div class="modal-body">
          @if (error()) {
            <div class="mensaje-error-modal">{{error()}}</div>
          }
          @if (mensajeExito()) {
            <div class="mensaje-exito-modal">{{mensajeExito()}}</div>
          }
          <form class="formulario-atencion" (ngSubmit)="guardarAtencion()" #atencionForm="ngForm">
            <!-- Información Básica -->
            <div class="form-seccion">
              <h4 class="seccion-titulo">Información Básica</h4>
              <div class="form-grid">
                <div class="form-group full-width">
                  <label for="pacienteAutocomplete" class="form-label requerido">Paciente</label>
                  <app-paciente-autocomplete id="pacienteAutocomplete" (pacienteSeleccionado)="asignarPaciente($event)"></app-paciente-autocomplete>
                  @if (pacienteSeleccionado) {
                    <div class="paciente-seleccionado-card">
                      <svg class="check-icon" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                      </svg>
                      <div class="paciente-info">
                        <span class="paciente-nombre">{{pacienteSeleccionado.nombres}} {{pacienteSeleccionado.apellidos}}</span>
                        <span class="paciente-datos">C.I. {{pacienteSeleccionado.cedula}} • {{pacienteSeleccionado.grado}}</span>
                      </div>
                    </div>
                  }
                </div>
                <!-- Fecha de atención -->
                <div class="form-group">
                  <label for="fechaAtencion" class="form-label requerido">Fecha de atención</label>
                  <input type="date" name="fechaAtencion" required id="fechaAtencion" class="form-input" [(ngModel)]="formModel.fechaAtencion">
                </div>
                <!-- Tipo de consulta -->
                <div class="form-group">
                  <label for="tipoConsulta" class="form-label requerido">Tipo de consulta</label>
                  <select name="tipoConsulta" required id="tipoConsulta" class="form-select" [(ngModel)]="formModel.tipoConsulta">
                    <option *ngFor="let tipo of tiposConsulta()" [value]="tipo.valor">{{tipo.label}}</option>
                  </select>
                </div>
                <!-- Horario debajo de fecha -->
                <div class="form-group">
                  <label for="horaInicio" class="form-label requerido">Horario</label>
                  <div class="horario-inputs">
                    <input type="time" name="horaInicio" required id="horaInicio" class="form-input hora-input" [(ngModel)]="formModel.horaInicio">
                    <span class="horario-separador">-</span>
                    <input type="time" name="horaFin" required id="horaFin" class="form-input hora-input" [(ngModel)]="formModel.horaFin">
                  </div>
                </div>
                <!-- Modalidad -->
                <div class="form-group">
                  <label for="tipoAtencion" class="form-label requerido">Modalidad</label>
                  <select name="tipoAtencion" required id="tipoAtencion" class="form-select" [(ngModel)]="formModel.tipoAtencion">
                    <option *ngFor="let tipo of tiposAtencion()" [value]="tipo.valor">{{tipo.label}}</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Motivo de Consulta -->
            <div class="form-seccion">
              <label for="motivoConsulta" class="form-label requerido">Motivo de consulta</label>
              <textarea name="motivoConsulta" required rows="3" id="motivoConsulta" class="form-textarea" placeholder="Describa el motivo principal de la consulta..." [(ngModel)]="formModel.motivoConsulta"></textarea>
            </div>
            
            <!-- Diagnósticos CIE-10 -->
            <div class="form-seccion">
              <h4 class="seccion-titulo">Diagnósticos CIE-10</h4>
              <div class="diagnosticos-container">
                <!-- Búsqueda -->
                <div class="diagnosticos-busqueda">
                  <input
                    type="text"
                    name="cie10Search"
                    placeholder="Buscar por código o nombre..."
                    class="busqueda-input"
                    [ngModel]="cie10SearchTerm()"
                    (ngModelChange)="cie10SearchTerm.set($event)"
                  >
                  @if (cie10SearchTerm() && cie10SearchTerm().length >= 2) {
                    <div class="busqueda-resultados">
                      @if (cargandoDiagnosticos()) {
                        <div class="instruccion-busqueda">Buscando...</div>
                      } @else if (diagnosticosFiltrados().length === 0) {
                        <div class="sin-resultados">No se encontraron diagnósticos</div>
                      } @else {
                        <div class="resultados-lista">
                          @for (diagnostico of diagnosticosFiltrados(); track diagnostico.id) {
                            <button
                              type="button"
                              class="diagnostico-opcion"
                              (click)="toggleDiagnostico(diagnostico.id!)"
                            >
                              <div class="diagnostico-info">
                                <span class="diagnostico-codigo">{{diagnostico.codigo}}</span>
                                <span class="diagnostico-nombre">{{diagnostico.nombre}}</span>
                              </div>
                            </button>
                          }
                        </div>
                      }
                    </div>
                  }
                </div>
                <!-- Seleccionados -->
                @if (formModel.diagnosticoIds && formModel.diagnosticoIds.length > 0) {
                  <div class="diagnosticos-seleccionados">
                    <h5 class="seleccionados-titulo">Diagnósticos seleccionados</h5>
                    <div class="seleccionados-lista">
                      @for (diagnosticoId of formModel.diagnosticoIds; track diagnosticoId) {
                        @let diagnostico = getDiagnosticoCIE10ById(diagnosticoId);
                        @if (diagnostico) {
                          <div class="diagnostico-seleccionado">
                            <div class="diagnostico-contenido">
                              <span class="diagnostico-codigo">{{diagnostico.codigo}}</span>
                              <span class="diagnostico-nombre">{{diagnostico.nombre}}</span>
                            </div>
                            <button type="button" class="diagnostico-eliminar" (click)="toggleDiagnostico(diagnosticoId)">
                              <svg viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                              </svg>
                            </button>
                          </div>
                        }
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
            
            <!-- Información Clínica -->
            <div class="form-seccion">
              <h4 class="seccion-titulo">Información Clínica</h4>
              <div class="form-columna" style="display: flex; flex-direction: column; gap: 18px;">
                <div class="form-group">
                  <label for="anamnesis" class="form-label">Anamnesis</label>
                  <textarea name="anamnesis" rows="4" id="anamnesis" class="form-textarea" placeholder="Historia clínica del paciente..." [(ngModel)]="formModel.anamnesis"></textarea>
                </div>
                <div class="form-group">
                  <label for="examenMental" class="form-label">Examen mental</label>
                  <textarea name="examenMental" rows="3" id="examenMental" class="form-textarea" placeholder="Observaciones del estado mental..." [(ngModel)]="formModel.examenMental"></textarea>
                </div>
                <div class="form-group">
                  <label for="impresionDiagnostica" class="form-label">Impresión diagnóstica</label>
                  <textarea name="impresionDiagnostica" rows="3" id="impresionDiagnostica" class="form-textarea" placeholder="Lo que observa el psicólogo..." [(ngModel)]="formModel.impresionDiagnostica"></textarea>
                </div>
                <div class="form-group">
                  <label for="planIntervencion" class="form-label">Plan de intervención</label>
                  <textarea name="planIntervencion" rows="3" id="planIntervencion" class="form-textarea" placeholder="Qué se va a hacer..." [(ngModel)]="formModel.planIntervencion"></textarea>
                </div>
                <div class="form-group">
                  <label for="recomendaciones" class="form-label">Recomendaciones</label>
                  <textarea name="recomendaciones" rows="3" id="recomendaciones" class="form-textarea" placeholder="Recomendaciones para el paciente..." [(ngModel)]="formModel.recomendaciones"></textarea>
                </div>
                <div class="form-group">
                  <label for="derivacion" class="form-label">Derivación</label>
                  <input type="text" name="derivacion" id="derivacion" class="form-input" placeholder="Si deriva a otro especialista..." [(ngModel)]="formModel.derivacion">
                </div>
              </div>
            </div>
            
            <!-- Seguimiento -->
            <div class="form-seccion">
              <h4 class="seccion-titulo">Seguimiento</h4>
              <div class="form-grid">
                <div class="form-group">
                  <label for="proximaCita" class="form-label">Próxima cita</label>
                  <input type="date" name="proximaCita" id="proximaCita" class="form-input" [(ngModel)]="formModel.proximaCita">
                </div>
                <div class="form-group full-width">
                  <label for="observacionesProximaCita" class="form-label">Observaciones</label>
                  <textarea name="observacionesProximaCita" rows="2" id="observacionesProximaCita" class="form-textarea" placeholder="Observaciones para la próxima cita..." [(ngModel)]="formModel.observacionesProximaCita"></textarea>
                </div>
              </div>
            </div>
            
            <!-- Footer del Formulario (alineado al modal Programar Atención) -->
            <div class="border-t border-slate-200 pt-6">
              <div class="flex justify-end gap-3">
                <!-- Cancelar -->
                <button
                  type="button"
                  (click)="cerrarModal()"
                  class="min-w-[11rem] rounded-full border border-slate-300 bg-white px-5 py-3 text-base font-semibold text-slate-700 hover:bg-slate-50 transition-all active:scale-[0.98] flex items-center justify-center gap-2"
                >
                  Cancelar
                </button>

                <!-- Guardar en curso (solo cuando aplica) -->
                @if (!modoEdicion() && !modoProgramada() && !modoFinalizar()) {
                  <button
                    type="button"
                    (click)="guardarEnCurso()"
                    [disabled]="cargandoAccion()"
                    [class]="'min-w-[11rem] rounded-full px-5 py-2.5 text-base font-semibold text-white transition-all active:scale-[0.98] flex items-center justify-center gap-2 ' +
                             (cargandoAccion() ? 'bg-amber-400 cursor-not-allowed' : 'bg-amber-600 hover:bg-amber-500')"
                  >
                    @if (cargandoAccion()) {
                      <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      Guardando...
                    } @else {
                      <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                      </svg>
                      Guardar en curso
                    }
                  </button>
                }

                <!-- Crear / Actualizar / Programar / Finalizar atención -->
                <button
                  type="submit"
                  [disabled]="cargandoAccion()"
                  [class]="'min-w-[11rem] rounded-full px-5 py-2.5 text-base font-semibold text-white transition-all active:scale-[0.98] flex items-center justify-center gap-2 ' +
                           (cargandoAccion() ? 'bg-slate-400 cursor-not-allowed' : 'bg-slate-900 hover:bg-slate-800')"
                >
                  @if (cargandoAccion()) {
                    <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Procesando...
                  } @else {
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12H8m8 0a4 4 0 11-8 0 4 4 0 018 0zm-4-8v8" />
                    </svg>
                    {{ modoFinalizar()
                        ? 'Finalizar atención'
                        : (modoEdicion() ? 'Actualizar' : modoProgramada() ? 'Programar' : 'Crear') + ' Atención' }}
                  }
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  }

  <!-- Modal Eliminar -->
  @if (showEliminarModal()) {
    <div class="modal-overlay" (click)="cerrarModalEliminar()" (keydown)="onModalKeyDown($event)">
      <div class="modal-container modal-sm" (click)="$event.stopPropagation()" (keydown)="onModalKeyDown($event)">
        <!-- Header -->
        <div class="modal-header">
          <div class="modal-header-contenido">
            <h3 class="modal-titulo">Confirmar Eliminación</h3>
            <p class="modal-subtitulo">¿Está seguro de eliminar esta atención?</p>
          </div>
          <button class="modal-cerrar" (click)="cerrarModalEliminar()">
            <svg viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <!-- Contenido -->
        <div class="modal-body">
          <div class="advertencia-eliminar">
            <svg class="advertencia-icono" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" 
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.998-.833-2.732 0L4.342 16.5c-.77.833.192 2.5 1.732 2.5z"/>
            </svg>
            <div class="advertencia-contenido">
              <h4>Advertencia</h4>
              <p>Esta acción eliminará permanentemente la atención y todos sus datos asociados. Esta acción no se puede deshacer.</p>
            </div>
          </div>
        </div>
        
        <!-- Footer -->
        <div class="modal-footer">
          <button
            type="button"
            (click)="cerrarModalEliminar()"
            class="modal-btn-secondary"
          >
            Cancelar
          </button>
          
          <button
            type="button"
            (click)="confirmarEliminarAtencion()"
            [disabled]="cargandoAccion()"
            class="modal-btn-primary"
          >
            @if (cargandoAccion()) {
              <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Procesando...
            } @else {
              Eliminar Permanentemente
            }
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Modal Programar Atención -->
  @if (showProgramarModal()) {
    <app-programar-atencion-modal 
      [show]="showProgramarModal()"
      [cargandoAccion]="programarCargandoAccion()"
      [error]="programarError()"
      [mensajeExito]="programarMensajeExito()"
      [psicologoActual]="psicologoActual()"
      [tiposConsulta]="tiposConsulta()"
      [tiposAtencion]="tiposAtencion()"
      [pacienteSeleccionado]="programarPacienteSeleccionado"
      [formModel]="programarFormModel"
      (cancelar)="cerrarProgramarModal()"
      (guardar)="guardarAtencionProgramada()"
      (asignarPaciente)="asignarPacienteProgramar($event)"
    ></app-programar-atencion-modal>
  }

  <!-- Modal Programar Seguimiento -->
  @if (showProgramarSeguimientoModal()) {
    <app-programar-seguimiento-modal 
      [show]="showProgramarSeguimientoModal()"
      [cargandoAccion]="programarSeguimientoCargandoAccion()"
      [error]="programarSeguimientoError()"
      [mensajeExito]="programarSeguimientoMensajeExito()"
      [psicologoActual]="psicologoActual()"
      [diagnosticos]="todosDiagnosticosCIE10()"
      [pacienteSeleccionado]="programarPacienteSeleccionado"
      [formModel]="programarSeguimientoFormModel"
      (cancelar)="cerrarProgramarSeguimientoModal()"
      (guardar)="guardarSeguimientoProgramado()"
      (asignarPaciente)="asignarPacienteProgramar($event)"
    ></app-programar-seguimiento-modal>
  }

  <!-- Modal Detalle -->
  @if (showDetalleModal()) {
    <app-atencion-detalle
      [atencionId]="detalleAtencionId()"
      (closeModal)="cerrarDetalleModal()">
    </app-atencion-detalle>
  }
</section>